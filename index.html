<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spay Digital Wallet</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            margin-top: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .app-title {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* Main App */
        .main-app {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-icons {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Balance Card */
        .balance-card {
            background: white;
            margin: 20px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .balance-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .balance-item {
            flex: 1;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .send-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .receive-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .business-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* Profile Section */
        .profile-info {
            padding: 20px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .profile-label {
            color: #666;
        }

        .profile-value {
            font-weight: 600;
            color: #333;
        }

        /* Transaction List */
        .transaction-list {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .transaction-item:hover {
            background: #e8e8e8;
            transform: translateX(5px);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .transaction-type {
            font-weight: 600;
            color: #333;
        }

        .transaction-amount {
            font-weight: bold;
        }

        .transaction-amount.positive {
            color: #4caf50;
        }

        .transaction-amount.negative {
            color: #f44336;
        }

        .transaction-date {
            color: #999;
            font-size: 12px;
        }

        /* Conversion Section */
        .conversion-section {
            padding: 20px;
        }

        .conversion-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .conversion-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .conversion-rate {
            text-align: center;
            color: #666;
            margin: 15px 0;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn:first-child {
            border-radius: 10px 0 0 10px;
        }

        .toggle-btn:last-child {
            border-radius: 0 10px 10px 0;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .error {
            color: #f44336;
            text-align: center;
            margin-top: 10px;
        }

        .success {
            color: #4caf50;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <h1 class="app-title">Spay Wallet</h1>
            
            <div class="toggle-group">
                <button class="toggle-btn active" onclick="toggleAuth('login')">Login</button>
                <button class="toggle-btn" onclick="toggleAuth('register')">Register</button>
            </div>
            
            <div id="authForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="Enter your email">
                </div>
                
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                
                <div class="input-group" id="phoneGroup" style="display: none;">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="+1234567890">
                </div>
                
                <button class="btn btn-primary" id="authBtn" onclick="handleAuth()">Login</button>
                <button class="btn btn-secondary" onclick="googleSignIn()">Sign in with Google</button>
                
                <div id="authMessage"></div>
            </div>
        </div>

        <!-- Main App -->
        <div class="main-app" id="mainApp">
            <!-- Header -->
            <div class="app-header">
                <h2>Spay Wallet</h2>
                <div class="header-icons">
                    <button class="icon-btn" onclick="openNotifications()" title="Conversions">ðŸ’±</button>
                    <button class="icon-btn" onclick="openTransactions()" title="Transactions">ðŸ“Š</button>
                    <button class="icon-btn" onclick="openProfile()" title="Profile">ðŸ‘¤</button>
                </div>
            </div>

            <!-- Balance Card -->
            <div class="balance-card">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="totalBalance">$0.00</div>
                
                <div class="balance-row">
                    <div class="balance-item">
                        <div class="balance-label">Cash Balance</div>
                        <div style="font-size: 20px; font-weight: bold;">$<span id="cashBalance">0.00</span></div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">Coin Balance</div>
                        <div style="font-size: 20px; font-weight: bold;">ðŸª™ <span id="coinBalance">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn send-btn" onclick="openSend()">
                    <span style="font-size: 24px;">ðŸ“¤</span>
                    <span>Send</span>
                </button>
                <button class="action-btn receive-btn" onclick="openReceive()">
                    <span style="font-size: 24px;">ðŸ“¥</span>
                    <span>Receive</span>
                </button>
            </div>
            
            <div style="margin: 0 20px;">
                <button class="btn business-btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="openBusinessPayment()">
                    <span style="font-size: 20px;">ðŸ’¼</span> Business Payment
                </button>
            </div>
        </div>

        <!-- Modals -->
        <!-- Profile Modal -->
        <div class="modal" id="profileModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
                <div class="modal-header">Profile</div>
                
                <div class="profile-info">
                    <div class="profile-item">
                        <span class="profile-label">Username</span>
                        <span class="profile-value" id="profileUsername">-</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-label">Email</span>
                        <span class="profile-value" id="profileEmail">-</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-label">Phone Number</span>
                        <span class="profile-value" id="profilePhone">-</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-label">User ID</span>
                        <span class="profile-value" id="profileId" style="font-size: 12px;">-</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary" style="background: #f44336; color: white;" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Send Modal -->
        <div class="modal" id="sendModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('sendModal')">&times;</button>
                <div class="modal-header">Send Money</div>
                
                <div class="input-group">
                    <label>Recipient (Email or Phone)</label>
                    <input type="text" id="sendRecipient" placeholder="email@example.com or +1234567890">
                </div>
                
                <div class="input-group">
                    <label>Amount ($)</label>
                    <input type="number" id="sendAmount" placeholder="0.00" step="0.01">
                </div>
                
                <button class="btn btn-primary" onclick="sendMoney()">Send Cash</button>
                <div id="sendMessage"></div>
            </div>
        </div>

        <!-- Receive Modal -->
        <div class="modal" id="receiveModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('receiveModal')">&times;</button>
                <div class="modal-header">Receive Money</div>
                
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #666; margin-bottom: 20px;">Share your email or phone to receive money</p>
                    
                    <div class="profile-item">
                        <span class="profile-label">Email</span>
                        <span class="profile-value" id="receiveEmail">-</span>
                    </div>
                    
                    <div class="profile-item">
                        <span class="profile-label">Phone</span>
                        <span class="profile-value" id="receivePhone">-</span>
                    </div>
                    
                    <div class="profile-item">
                        <span class="profile-label">User ID</span>
                        <span class="profile-value" style="font-size: 12px;" id="receiveId">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Modal -->
        <div class="modal" id="transactionsModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('transactionsModal')">&times;</button>
                <div class="modal-header">Transaction History</div>
                
                <div class="transaction-list" id="transactionList">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Transaction Detail Modal -->
        <div class="modal" id="transactionDetailModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('transactionDetailModal')">&times;</button>
                <div class="modal-header">Transaction Details</div>
                
                <div id="transactionDetails">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Notifications/Conversion Modal -->
        <div class="modal" id="notificationsModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('notificationsModal')">&times;</button>
                <div class="modal-header">Currency Conversion</div>
                
                <div class="conversion-section">
                    <div class="toggle-group">
                        <button class="toggle-btn active" id="cashToCoinBtn" onclick="toggleConversion('cashToCoin')">Cash to Coin</button>
                        <button class="toggle-btn" id="coinToCashBtn" onclick="toggleConversion('coinToCash')">Coin to Cash</button>
                    </div>
                    
                    <div class="conversion-rate">1 Coin = $1.00 USD</div>
                    
                    <div class="conversion-input">
                        <input type="number" id="conversionAmount" placeholder="Enter amount" step="0.01">
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span id="conversionResult" style="font-size: 18px; color: #667eea;">-</span>
                    </div>
                    
                    <button class="btn btn-primary" onclick="performConversion()">Convert</button>
                    <div id="conversionMessage"></div>
                </div>
            </div>
        </div>

        <!-- Business Payment Modal -->
        <div class="modal" id="businessModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('businessModal')">&times;</button>
                <div class="modal-header">Business Payment</div>
                
                <div class="input-group">
                    <label>Business Email</label>
                    <input type="email" id="businessEmail" placeholder="business@example.com">
                </div>
                
                <div class="input-group">
                    <label>Amount ($)</label>
                    <input type="number" id="businessAmount" placeholder="0.00" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" id="businessDescription" placeholder="Payment for...">
                </div>
                
                <button class="btn btn-primary" onclick="makeBusinessPayment()">Pay Business</button>
                <div id="businessMessage"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJ5kTNtHVBmAySNxskC-sejx2h07KxyvI",
            authDomain: "spay-191ff.firebaseapp.com",
            projectId: "spay-191ff",
            storageBucket: "spay-191ff.appspot.com",
            messagingSenderId: "237078619197",
            appId: "1:237078619197:web:77831f473393c8d9d87654",
            measurementId: "G-M7PM8E57ZB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let userData = null;
        let authMode = 'login';
        let conversionMode = 'cashToCoin';

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                showMainApp();
            } else {
                currentUser = null;
                userData = null;
                showLoginScreen();
            }
        });

        // Toggle between login and register
        function toggleAuth(mode) {
            authMode = mode;
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const authBtn = document.getElementById('authBtn');
            const phoneGroup = document.getElementById('phoneGroup');
            
            if (mode === 'register') {
                authBtn.textContent = 'Register';
                phoneGroup.style.display = 'block';
            } else {
                authBtn.textContent = 'Login';
                phoneGroup.style.display = 'none';
            }
        }

        // Handle authentication
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const phone = document.getElementById('phone').value;
            const messageDiv = document.getElementById('authMessage');
            
            if (!email || !password) {
                messageDiv.innerHTML = '<div class="error">Please fill in all fields</div>';
                return;
            }
            
            try {
                if (authMode === 'register') {
                    if (!phone) {
                        messageDiv.innerHTML = '<div class="error">Please provide a phone number</div>';
                        return;
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await createUserDocument(userCredential.user, phone);
                    messageDiv.innerHTML = '<div class="success">Registration successful!</div>';
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    messageDiv.innerHTML = '<div class="success">Login successful!</div>';
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Google Sign In
        async function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const userDoc = await db.collection('users').doc(result.user.uid).get();
                
                if (!userDoc.exists) {
                    // For Google sign-in, we'll use a placeholder phone
                    await createUserDocument(result.user, '+1000000000');
                }
            } catch (error) {
                document.getElementById('authMessage').innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Create user document
        async function createUserDocument(user, phone) {
            const userRef = db.collection('users').doc(user.uid);
            
            await userRef.set({
                email: user.email,
                phone: phone,
                address: generateWalletAddress(),
                balance: 1000, // Initial token balance
                cashBalance: 100, // Initial cash balance
                transactions: [
                    {
                        type: 'deposit',
                        amount: 100,
                        method: 'Welcome Bonus',
                        date: firebase.firestore.Timestamp.now()
                    }
                ],
                createdAt: firebase.firestore.Timestamp.now()
            });
        }

        // Generate unique wallet address
        function generateWalletAddress() {
            const chars = '0123456789abcdef';
            let address = '0x';
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        }

        // Load user data
        async function loadUserData() {
            if (!currentUser) return;
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            userData = userDoc.data();
            
            updateBalances();
            updateProfileInfo();
        }

        // Update balances
        function updateBalances() {
            if (!userData) return;
            
            const cashBalance = userData.cashBalance || 0;
            const coinBalance = userData.balance || 0;
            const totalBalance = cashBalance + coinBalance; // Since 1 coin = $1
            
            document.getElementById('cashBalance').textContent = cashBalance.toFixed(2);
            document.getElementById('coinBalance').textContent = coinBalance;
            document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
        }

        // Update profile info
        function updateProfileInfo() {
            if (!userData || !currentUser) return;
            
            const username = currentUser.email.split('@')[0];
            
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = userData.phone || 'Not provided';
            document.getElementById('profileId').textContent = currentUser.uid;
            
            document.getElementById('receiveEmail').textContent = currentUser.email;
            document.getElementById('receivePhone').textContent = userData.phone || 'Not provided';
            document.getElementById('receiveId').textContent = currentUser.uid;
        }

        // Send money
        async function sendMoney() {
            const recipient = document.getElementById('sendRecipient').value;
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const messageDiv = document.getElementById('sendMessage');
            
            if (!recipient || !amount || amount <= 0) {
                messageDiv.innerHTML = '<div class="error">Please enter valid recipient and amount</div>';
                return;
            }
            
            if (amount > userData.cashBalance) {
                messageDiv.innerHTML = '<div class="error">Insufficient balance</div>';
                return;
            }
            
            try {
                // Find recipient by email or phone
                let recipientDoc;
                const emailQuery = await db.collection('users').where('email', '==', recipient).get();
                
                if (!emailQuery.empty) {
                    recipientDoc = emailQuery.docs[0];
                } else {
                    const phoneQuery = await db.collection('users').where('phone', '==', recipient).get();
                    if (!phoneQuery.empty) {
                        recipientDoc = phoneQuery.docs[0];
                    }
                }
                
                if (!recipientDoc) {
                    messageDiv.innerHTML = '<div class="error">Recipient not found</div>';
                    return;
                }
                
                const recipientData = recipientDoc.data();
                
                // Update sender balance
                await db.collection('users').doc(currentUser.uid).update({
                    cashBalance: userData.cashBalance - amount,
                    transactions: firebase.firestore.FieldValue.arrayUnion({
                        type: 'send_cash',
                        amount: amount,
                        to: recipientData.email,
                        date: firebase.firestore.Timestamp.now()
                    })
                });
                
                // Update recipient balance
                await db.collection('users').doc(recipientDoc.id).update({
                    cashBalance: (recipientData.cashBalance || 0) + amount,
                    transactions: firebase.firestore.FieldValue.arrayUnion({
                        type: 'receive_cash',
                        amount: amount,
                        from: currentUser.email,
                        date: firebase.firestore.Timestamp.now()
                    })
                });
                
                messageDiv.innerHTML = '<div class="success">Money sent successfully!</div>';
                await loadUserData();
                
                setTimeout(() => {
                    closeModal('sendModal');
                    document.getElementById('sendRecipient').value = '';
                    document.getElementById('sendAmount').value = '';
                    messageDiv.innerHTML = '';
                }, 1500);
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Load transactions
        async function loadTransactions() {
            if (!userData) return;
            
            const transactionList = document.getElementById('transactionList');
            const transactions = userData.transactions || [];
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<p style="text-align: center; color: #999;">No transactions yet</p>';
                return;
            }
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...transactions].sort((a, b) => {
                return b.date.seconds - a.date.seconds;
            });
            
            transactionList.innerHTML = '';
            sortedTransactions.forEach((transaction, index) => {
                const date = transaction.date.toDate();
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                let typeStr = '';
                let amountStr = '';
                let isPositive = false;
                
                switch(transaction.type) {
                    case 'deposit':
                        typeStr = 'ðŸ’° Deposit';
                        amountStr = `+${transaction.amount}`;
                        isPositive = true;
                        break;
                    case 'send_cash':
                        typeStr = 'ðŸ“¤ Sent to ' + (transaction.to || 'Unknown');
                        amountStr = `-${transaction.amount}`;
                        break;
                    case 'receive_cash':
                        typeStr = 'ðŸ“¥ Received from ' + (transaction.from || 'Unknown');
                        amountStr = `+${transaction.amount}`;
                        isPositive = true;
                        break;
                    case 'receive_token':
                        typeStr = 'ðŸª™ Received Coins';
                        amountStr = `+${transaction.amount} coins`;
                        isPositive = true;
                        break;
                    case 'conversion':
                        typeStr = 'ðŸ’± ' + (transaction.conversionType || 'Conversion');
                        amountStr = transaction.result;
                        isPositive = transaction.conversionType === 'Coin to Cash';
                        break;
                    default:
                        typeStr = transaction.type;
                        amountStr = `${transaction.amount}`;
                }
                
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.onclick = () => showTransactionDetail(transaction, index);
                item.innerHTML = `
                    <div class="transaction-header">
                        <span class="transaction-type">${typeStr}</span>
                        <span class="transaction-amount ${isPositive ? 'positive' : 'negative'}">${amountStr}</span>
                    </div>
                    <div class="transaction-date">${dateStr}</div>
                `;
                
                transactionList.appendChild(item);
            });
        }

        // Show transaction detail
        function showTransactionDetail(transaction, index) {
            const detailsDiv = document.getElementById('transactionDetails');
            const date = transaction.date.toDate();
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            let detailHTML = '<div class="profile-info">';
            
            detailHTML += `<div class="profile-item">
                <span class="profile-label">Transaction ID</span>
                <span class="profile-value">#${String(index + 1).padStart(6, '0')}</span>
            </div>`;
            
            detailHTML += `<div class="profile-item">
                <span class="profile-label">Type</span>
                <span class="profile-value">${transaction.type.replace('_', ' ').toUpperCase()}</span>
            </div>`;
            
            detailHTML += `<div class="profile-item">
                <span class="profile-label">Amount</span>
                <span class="profile-value">${transaction.amount || '0'}</span>
            </div>`;
            
            if (transaction.from) {
                detailHTML += `<div class="profile-item">
                    <span class="profile-label">From</span>
                    <span class="profile-value">${transaction.from}</span>
                </div>`;
            }
            
            if (transaction.to) {
                detailHTML += `<div class="profile-item">
                    <span class="profile-label">To</span>
                    <span class="profile-value">${transaction.to}</span>
                </div>`;
            }
            
            if (transaction.method) {
                detailHTML += `<div class="profile-item">
                    <span class="profile-label">Method</span>
                    <span class="profile-value">${transaction.method}</span>
                </div>`;
            }
            
            detailHTML += `<div class="profile-item">
                <span class="profile-label">Date & Time</span>
                <span class="profile-value">${dateStr}</span>
            </div>`;
            
            detailHTML += `<div class="profile-item">
                <span class="profile-label">Status</span>
                <span class="profile-value" style="color: #4caf50;">Completed</span>
            </div>`;
            
            detailHTML += '</div>';
            
            detailsDiv.innerHTML = detailHTML;
            
            closeModal('transactionsModal');
            showModal('transactionDetailModal');
        }

        // Toggle conversion mode
        function toggleConversion(mode) {
            conversionMode = mode;
            document.getElementById('cashToCoinBtn').classList.toggle('active', mode === 'cashToCoin');
            document.getElementById('coinToCashBtn').classList.toggle('active', mode === 'coinToCash');
            document.getElementById('conversionAmount').value = '';
            document.getElementById('conversionResult').textContent = '-';
        }

        // Calculate conversion
        document.getElementById('conversionAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const resultDiv = document.getElementById('conversionResult');
            
            if (amount > 0) {
                if (conversionMode === 'cashToCoin') {
                    resultDiv.textContent = `= ${amount} Coins`;
                } else {
                    resultDiv.textContent = `= ${amount.toFixed(2)} USD`;
                }
            } else {
                resultDiv.textContent = '-';
            }
        });

        // Perform conversion
        async function performConversion() {
            const amount = parseFloat(document.getElementById('conversionAmount').value);
            const messageDiv = document.getElementById('conversionMessage');
            
            if (!amount || amount <= 0) {
                messageDiv.innerHTML = '<div class="error">Please enter a valid amount</div>';
                return;
            }
            
            try {
                let updateData = {};
                let transactionData = {};
                
                if (conversionMode === 'cashToCoin') {
                    if (amount > userData.cashBalance) {
                        messageDiv.innerHTML = '<div class="error">Insufficient cash balance</div>';
                        return;
                    }
                    
                    updateData = {
                        cashBalance: userData.cashBalance - amount,
                        balance: userData.balance + amount
                    };
                    
                    transactionData = {
                        type: 'conversion',
                        conversionType: 'Cash to Coin',
                        amount: amount,
                        result: `${amount} â†’ ${amount} Coins`,
                        date: firebase.firestore.Timestamp.now()
                    };
                } else {
                    if (amount > userData.balance) {
                        messageDiv.innerHTML = '<div class="error">Insufficient coin balance</div>';
                        return;
                    }
                    
                    updateData = {
                        cashBalance: userData.cashBalance + amount,
                        balance: userData.balance - amount
                    };
                    
                    transactionData = {
                        type: 'conversion',
                        conversionType: 'Coin to Cash',
                        amount: amount,
                        result: `${amount} Coins â†’ ${amount}`,
                        date: firebase.firestore.Timestamp.now()
                    };
                }
                
                updateData.transactions = firebase.firestore.FieldValue.arrayUnion(transactionData);
                
                await db.collection('users').doc(currentUser.uid).update(updateData);
                
                messageDiv.innerHTML = '<div class="success">Conversion successful!</div>';
                await loadUserData();
                
                setTimeout(() => {
                    closeModal('notificationsModal');
                    document.getElementById('conversionAmount').value = '';
                    document.getElementById('conversionResult').textContent = '-';
                    messageDiv.innerHTML = '';
                }, 1500);
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Make business payment
        async function makeBusinessPayment() {
            const businessEmail = document.getElementById('businessEmail').value;
            const amount = parseFloat(document.getElementById('businessAmount').value);
            const description = document.getElementById('businessDescription').value;
            const messageDiv = document.getElementById('businessMessage');
            
            if (!businessEmail || !amount || amount <= 0 || !description) {
                messageDiv.innerHTML = '<div class="error">Please fill in all fields</div>';
                return;
            }
            
            if (amount > userData.cashBalance) {
                messageDiv.innerHTML = '<div class="error">Insufficient balance</div>';
                return;
            }
            
            try {
                // Find business account
                const businessQuery = await db.collection('users').where('email', '==', businessEmail).get();
                
                if (businessQuery.empty) {
                    messageDiv.innerHTML = '<div class="error">Business not found</div>';
                    return;
                }
                
                const businessDoc = businessQuery.docs[0];
                const businessData = businessDoc.data();
                
                // Create escrow document
                const escrowRef = await db.collection('escrow').add({
                    sellerId: businessDoc.id,
                    sellerEmail: businessEmail,
                    buyerId: currentUser.uid,
                    buyerEmail: currentUser.email,
                    productDetails: description,
                    price: amount,
                    status: 'completed',
                    createdAt: firebase.firestore.Timestamp.now()
                });
                
                // Update buyer balance
                await db.collection('users').doc(currentUser.uid).update({
                    cashBalance: userData.cashBalance - amount,
                    transactions: firebase.firestore.FieldValue.arrayUnion({
                        type: 'send_cash',
                        amount: amount,
                        to: businessEmail,
                        description: description,
                        businessPayment: true,
                        escrowId: escrowRef.id,
                        date: firebase.firestore.Timestamp.now()
                    })
                });
                
                // Update business balance
                await db.collection('users').doc(businessDoc.id).update({
                    cashBalance: (businessData.cashBalance || 0) + amount,
                    transactions: firebase.firestore.FieldValue.arrayUnion({
                        type: 'receive_cash',
                        amount: amount,
                        from: currentUser.email,
                        description: description,
                        businessPayment: true,
                        escrowId: escrowRef.id,
                        date: firebase.firestore.Timestamp.now()
                    })
                });
                
                messageDiv.innerHTML = '<div class="success">Business payment successful!</div>';
                await loadUserData();
                
                setTimeout(() => {
                    closeModal('businessModal');
                    document.getElementById('businessEmail').value = '';
                    document.getElementById('businessAmount').value = '';
                    document.getElementById('businessDescription').value = '';
                    messageDiv.innerHTML = '';
                }, 1500);
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openProfile() {
            showModal('profileModal');
        }

        function openSend() {
            showModal('sendModal');
        }

        function openReceive() {
            showModal('receiveModal');
        }

        function openTransactions() {
            loadTransactions();
            showModal('transactionsModal');
        }

        function openNotifications() {
            showModal('notificationsModal');
        }

        function openBusinessPayment() {
            showModal('businessModal');
        }

        // Show/Hide screens
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Logout
        function logout() {
            auth.signOut();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
