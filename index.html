<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Business Payment Demo</title>

  <!-- Tailwind CDN – remove if you already use it -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v9 modular SDK (only the services we need) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      updateDoc,
      arrayUnion,
      Timestamp,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    /* ---------- Firebase config – replace with your own values ---------- */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    /* ---------- Init Firebase ------------------------------------------ */
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db   = getFirestore(firebaseApp);

    /* ---------- Global state ------------------------------------------- */
    const state = {
      currentUser: null,
      pendingCost: 0
    };

    /* ---------- UI helpers --------------------------------------------- */
    function showToast(msg, type = "info") {
      // Simple alert – replace with your own toast system if you have one
      alert(`${type.toUpperCase()}: ${msg}`);
    }

    /* ---------- Auth handling ------------------------------------------ */
    onAuthStateChanged(auth, user => {
      state.currentUser = user;
      if (user) {
        document.getElementById("home-page").classList.remove("hidden");
        document.getElementById("login-page").classList.add("hidden");
      } else {
        document.getElementById("home-page").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
    });

    /* ---------- Event listeners ---------------------------------------- */
    // Home → Business Payment
    document.getElementById("business-payment-btn")?.addEventListener("click", () => {
      showProductDetails();  // populate & show the product page
    });

    // Buy button
    document.getElementById("buy-btn")?.addEventListener("click", () => {
      renderBuyForm();
    });

    // Sell button
    document.getElementById("sell-btn")?.addEventListener("click", async () => {
      const escrowId = localStorage.getItem("lastEscrow");
      if (!escrowId) { showToast("No pending purchase to claim.", "error"); return; }

      const escrowRef = doc(db, "escrow", escrowId);
      try {
        await runTransaction(db, async transaction => {
          const escSnap = await transaction.get(escrowRef);
          if (!escSnap.exists()) throw new Error("Escrow not found");
          if (escSnap.data().status !== "pending_payment")
            throw new Error("Already claimed");

          // Claim the escrow
          transaction.update(escrowRef, {
            sellerId: state.currentUser.uid,
            status: "awaiting_buyer"
          });
        });

        showToast("Escrow claimed. Awaiting buyer confirmation.", "success");
      } catch (err) {
        showToast(err.message, "error");
      }
    });

    // PIN modal – Cancel
    document.getElementById("cancel-pin-btn")?.addEventListener("click", () => {
      document.getElementById("pin-modal").classList.add("hidden");
    });

    // PIN modal – Confirm
    document.getElementById("confirm-pin-btn")?.addEventListener("click", async () => {
      const pin = document.getElementById("pin-input").value;
      if (pin !== state.currentUser.pin) {   // `pin` must be stored in the user profile
        document.getElementById("pin-error").textContent = "Wrong PIN";
        document.getElementById("pin-error").classList.remove("hidden");
        return;
      }

      await handlePayment(state.pendingCost);
    });

    /* ---------- Helper functions --------------------------------------- */
    function showProductDetails() {
      // Dummy data – replace with real product info or load from Firestore
      const prod = { id: "prod_001", title: "Super Widget" };

      document.getElementById("prod-title").textContent = prod.title;
      localStorage.setItem("currentProdId", prod.id);

      // Show the page, hide others
      document.getElementById("product-details-page").classList.remove("hidden");
      document.getElementById("home-page").classList.add("hidden");
    }

    function renderBuyForm() {
      const container = document.getElementById("buy-form-container");
      container.innerHTML = `
        <form id="buy-form" class="p-4 border rounded-lg mt-6">
          <label for="cost-input" class="block mb-2 font-medium">Cost (tokens)</label>
          <input id="cost-input" type="number" min="1" placeholder="Enter amount"
                 class="w-full p-2 border rounded-md"/>
          <button type="submit" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg">
            Proceed to Pay
          </button>
        </form>`;
      document.getElementById("buy-form").addEventListener("submit", e => {
        e.preventDefault();
        const cost = parseInt(document.getElementById("cost-input").value, 10);
        if (!Number.isInteger(cost) || cost <= 0) return;
        state.pendingCost = cost;
        document.getElementById("pin-modal").classList.remove("hidden");
      });
    }

    async function handlePayment(cost) {
      const buyerRef = doc(db, "users", state.currentUser.uid);
      try {
        await runTransaction(db, async transaction => {
          const snap = await transaction.get(buyerRef);
          if (!snap.exists()) throw new Error("User not found");

          const balance = snap.data().balance || 0;
          if (balance < cost) throw new Error("Insufficient tokens");

          // Debit buyer
          transaction.update(buyerRef, {
            balance: balance - cost,
            transactions: arrayUnion({
              type: "payment_out",
              amount: cost,
              date: Timestamp.now()
            })
          });

          // Create escrow (no seller yet)
          const escrowId = await addDoc(collection(db, "escrow"), {
            productDetails: document.getElementById("prod-title").textContent,
            price: cost,
            buyerId: state.currentUser.uid,
            status: "pending_payment",
            createdAt: Timestamp.now()
          });

          localStorage.setItem("lastEscrow", escrowId.id);
        });

        showToast("Payment processed. Awaiting seller to claim.", "success");
        document.getElementById("pin-modal").classList.add("hidden");
      } catch (err) {
        showToast(err.message, "error");
      }
    }

  </script>
</head>

<body class="bg-gray-100 font-sans">

<!-- ===== Login Page (if you already have one) ===== -->
<div id="login-page" class="hidden">
  <!-- Your existing login form goes here -->
</div>

<!-- ===== Home / Main Page ===== -->
<div id="home-page" class="hidden flex flex-col items-center p-8 space-y-6">

  <h1 class="text-3xl font-bold mb-4">Welcome to the Demo App</h1>

  <!-- Existing content… -->

  <!-- New button that opens the Business Payment flow -->
  <button id="business-payment-btn"
          class="w-full max-w-sm py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
    Business Payment
  </button>
</div>

<!-- ===== Product Details Page ===== -->
<div id="product-details-page" class="hidden flex flex-col items-center p-8 space-y-6">

  <h2 id="prod-title" class="text-2xl font-semibold"></h2>

  <!-- Action buttons -->
  <div class="flex gap-4 mt-6">
    <button id="sell-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white">Sell</button>
    <button id="buy-btn"  class="px-6 py-2 rounded-lg bg-blue-600 text-white">Buy</button>
  </div>

  <!-- Container for the Buy form -->
  <div id="buy-form-container"></div>
</div>

<!-- ===== PIN Confirmation Modal ===== -->
<div id="pin-modal"
     class="fixed inset-0 flex items-center justify-center hidden bg-black/50
