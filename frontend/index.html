<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        /* Page transition styles */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out, visibility 0.4s;
            display: flex;
            flex-direction: column;
        }
        .page.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        .toast.show {
            transform: translateX(0);
        }
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(to right, #4F46E5, #818CF8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dark .gradient-text {
             background: linear-gradient(to right, #A5B4FC, #C7D2FE);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Animated background */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white dark:bg-gray-800 shadow-2xl flex flex-col relative overflow-hidden">

        <!-- Toast Notification -->
        <div id="toast" class="toast bg-green-500 text-white font-semibold">
            <p id="toast-message"></p>
        </div>

        <!-- Authentication Page -->
        <div id="auth-page" class="page active p-6 sm:p-8 flex-grow flex flex-col justify-center">
            <div class="text-center mb-10">
                <div class="inline-block p-4 bg-indigo-100 dark:bg-indigo-900/50 rounded-full">
                   <i data-lucide="wallet" class="h-12 w-12 text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h1 class="text-3xl font-extrabold mt-4 gradient-text">Welcome Back</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Sign in to manage your digital assets.</p>
            </div>

            <div id="auth-forms">
                <!-- Login Form -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 transition">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 transition">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 font-bold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 shadow-lg">Login</button>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        No account yet? <a href="#" id="show-register" class="font-semibold text-indigo-600 hover:text-indigo-500 dark:text-indigo-400">Create one now</a>
                    </p>
                </form>

                <!-- Register Form (hidden by default) -->
                <form id="register-form" class="hidden">
                     <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 transition">
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="register-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 transition">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 font-bold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 shadow-lg">Create Account</button>
                    <p class="text-center text-sm text-gray-500 mt-6">
                        Already registered? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:text-indigo-500 dark:text-indigo-400">Log in</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- Main App Page -->
        <div id="main-page" class="page">
            <header class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                <div>
                     <p class="text-sm text-gray-500 dark:text-gray-400">Welcome</p>
                     <p id="user-email-display" class="font-semibold text-gray-700 dark:text-gray-300"></p>
                </div>
                <div class="relative">
                    <button id="wallet-button" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="wallet-2"></i>
                    </button>
                </div>
            </header>
            <main class="p-6 flex-grow flex flex-col justify-center items-center text-center">
                 <p class="text-gray-500 dark:text-gray-400 font-medium">Total Balance</p>
                <div class="my-4 text-5xl font-extrabold gradient-text">
                    <span id="main-balance">0.00</span> TKN
                </div>
                <div class="grid grid-cols-2 gap-6 w-full max-w-xs mt-10">
                    <button id="send-button" class="flex flex-col items-center justify-center bg-indigo-600 text-white p-6 rounded-2xl shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 hover:-translate-y-1">
                        <i data-lucide="arrow-up-circle" class="h-10 w-10 mb-2"></i>
                        <span class="font-bold">Send</span>
                    </button>
                    <button id="receive-button" class="flex flex-col items-center justify-center bg-green-500 text-white p-6 rounded-2xl shadow-lg hover:bg-green-600 transition transform hover:scale-105 hover:-translate-y-1">
                        <i data-lucide="arrow-down-circle" class="h-10 w-10 mb-2"></i>
                        <span class="font-bold">Receive</span>
                    </button>
                </div>
                 <button id="logout-button" class="absolute bottom-6 text-sm text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">Logout</button>
            </main>
        </div>

        <!-- Wallet Page -->
        <div id="wallet-page" class="page">
            <header class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
                <button class="back-to-main-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <i data-lucide="arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold">My Wallet</h1>
            </header>
            <main class="p-6 flex-grow overflow-y-auto">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-8 rounded-2xl mb-8 text-center shadow-xl">
                    <p class="text-sm opacity-80">Remaining Tokens</p>
                    <p class="text-5xl font-extrabold mt-2"><span id="wallet-balance">0.00</span> TKN</p>
                </div>
                
                 <div class="grid grid-cols-1 gap-6 mb-8">
                    <form id="token-to-cash-form" class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl">
                        <h3 class="font-semibold mb-3">Convert Token to Cash</h3>
                        <div class="flex items-center">
                            <input type="number" id="token-amount" placeholder="Tokens" class="w-full px-3 py-2 border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 transition" step="0.01" min="0">
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg font-semibold hover:bg-indigo-700 transition">Convert</button>
                        </div>
                    </form>
                    <form id="cash-to-token-form" class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl">
                        <h3 class="font-semibold mb-3">Buy Tokens with Cash</h3>
                        <div class="flex items-center">
                            <input type="number" id="cash-amount" placeholder="Cash ($)" class="w-full px-3 py-2 border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 transition" step="0.01" min="0">
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-r-lg font-semibold hover:bg-green-600 transition">Buy</button>
                        </div>
                    </form>
                </div>

                <div>
                    <h2 class="text-lg font-semibold mb-4">Transaction History</h2>
                    <ul id="transaction-list" class="space-y-3">
                       <li class="text-center text-gray-500 dark:text-gray-400 py-4">No transactions yet.</li>
                    </ul>
                </div>
            </main>
        </div>

        <!-- Send Page -->
        <div id="send-page" class="page">
            <header class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700">
                <button class="back-to-main-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <i data-lucide="arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold">Send Tokens</h1>
            </header>
            <main class="p-6 flex-grow">
                 <form id="send-token-form">
                    <div class="mb-5">
                        <label for="recipient-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Recipient's Address</label>
                        <input type="text" id="recipient-address" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 transition" placeholder="0x...">
                    </div>
                    <div class="mb-8">
                        <label for="send-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount (TKN)</label>
                        <input type="number" id="send-amount" required class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 transition" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 font-bold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 shadow-lg">Confirm & Send</button>
                </form>
            </main>
        </div>

        <!-- Receive Page -->
        <div id="receive-page" class="page">
             <header class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700">
                <button class="back-to-main-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <i data-lucide="arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold">Receive Tokens</h1>
            </header>
            <main class="p-6 flex-grow flex flex-col items-center justify-center text-center">
                <p class="mb-4 text-gray-600 dark:text-gray-400">Share this address to receive tokens.</p>
                <div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-xl w-full max-w-sm">
                    <p id="wallet-address" class="font-mono break-all text-sm">0xAbC123...dEf456</p>
                </div>
                <button id="copy-address-btn" class="mt-8 bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 font-semibold shadow-md flex items-center space-x-2">
                   <i data-lucide="copy" class="h-4 w-4"></i>
                   <span>Copy Address</span>
                </button>
            </main>
        </div>
        
        <!-- Payment Gateway Page -->
        <div id="payment-gateway-page" class="page">
            <header class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700">
                <button id="back-to-wallet-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">
                    <i data-lucide="arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold">Complete Payment</h1>
            </header>
            <main class="p-6 flex-grow overflow-y-auto">
                <div class="text-center mb-8">
                    <p class="text-gray-500 dark:text-gray-400">You are paying</p>
                    <p class="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400 mt-1">$<span id="payment-amount-display">0.00</span></p>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-xl">
                     <div class="flex border-b border-gray-300 dark:border-gray-600 mb-4">
                        <button data-payment="upi" class="payment-tab flex-1 py-3 font-semibold border-b-2 text-indigo-600 dark:text-indigo-300 border-indigo-600 dark:border-indigo-300">UPI</button>
                        <button data-payment="card" class="payment-tab text-gray-500 flex-1 py-3 font-semibold border-b-2 border-transparent">Card</button>
                     </div>
                     
                     <div class="p-4">
                         <!-- UPI Form -->
                         <div id="upi-payment-form" class="payment-form">
                            <label for="upi-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Enter UPI ID</label>
                            <input type="text" id="upi-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 transition" placeholder="yourname@bank">
                         </div>

                         <!-- Card Form -->
                         <div id="card-payment-form" class="payment-form hidden">
                             <div class="mb-4">
                                <label for="card-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Card Number</label>
                                <input type="text" id="card-number" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 transition" placeholder="0000 0000 0000 0000">
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                    <label for="card-expiry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expiry</label>
                                    <input type="text" id="card-expiry" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 transition" placeholder="MM/YY">
                                 </div>
                                  <div>
                                    <label for="card-cvc" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CVC</label>
                                    <input type="text" id="card-cvc" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 transition" placeholder="123">
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>

                <button id="pay-now-btn" class="mt-8 w-full bg-green-500 text-white py-3 px-4 font-bold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105 shadow-lg">Pay Now</button>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Icon initialization ---
            lucide.createIcons();

            const USERS_STORAGE_KEY = 'digital-wallet-users';
            const SESSION_STORAGE_KEY = 'digital-wallet-session';

            // --- State Management ---
            const state = {
                currentUser: null,
                pendingPurchaseAmount: 0,
                users: {
                    "test@example.com": {
                        password: "password123",
                        balance: 1350.75,
                        address: '0x1a2b3c4d5e6f7g8h9i0j',
                        transactions: [
                            { type: 'receive', amount: 1500, from: 'Initial Deposit', date: '2023-10-26' },
                            { type: 'send', amount: 149.25, to: '0xZ1Y2X3...', date: '2023-10-27' },
                        ]
                    }
                }
            };
            
            // --- Persistence Functions ---
            function saveState() {
                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(state.users));
                if (state.currentUser) {
                    sessionStorage.setItem(SESSION_STORAGE_KEY, state.currentUser);
                } else {
                    sessionStorage.removeItem(SESSION_STORAGE_KEY);
                }
            }

            function loadState() {
                const storedUsers = localStorage.getItem(USERS_STORAGE_KEY);
                if (storedUsers) {
                    state.users = JSON.parse(storedUsers);
                }
                
                const storedSession = sessionStorage.getItem(SESSION_STORAGE_KEY);
                if (storedSession && state.users[storedSession]) {
                    state.currentUser = storedSession;
                }
            }


            // --- DOM Elements ---
            const pages = document.querySelectorAll('.page');
            const authPage = document.getElementById('auth-page');
            const mainPage = document.getElementById('main-page');
            const walletPage = document.getElementById('wallet-page');
            const sendPage = document.getElementById('send-page');
            const receivePage = document.getElementById('receive-page');
            const paymentGatewayPage = document.getElementById('payment-gateway-page');

            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register');
            const showLoginLink = document.getElementById('show-login');

            const walletButton = document.getElementById('wallet-button');
            const backToMainBtns = document.querySelectorAll('.back-to-main-btn');
            const sendButton = document.getElementById('send-button');
            const receiveButton = document.getElementById('receive-button');
            const logoutButton = document.getElementById('logout-button');
            
            const mainBalanceEl = document.getElementById('main-balance');
            const walletBalanceEl = document.getElementById('wallet-balance');
            const userEmailDisplay = document.getElementById('user-email-display');
            const transactionList = document.getElementById('transaction-list');

            const tokenToCashForm = document.getElementById('token-to-cash-form');
            const cashToTokenForm = document.getElementById('cash-to-token-form');
            const sendTokenForm = document.getElementById('send-token-form');
            
            const walletAddressEl = document.getElementById('wallet-address');
            const copyAddressBtn = document.getElementById('copy-address-btn');

            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // Payment Gateway elements
            const backToWalletBtn = document.getElementById('back-to-wallet-btn');
            const paymentAmountDisplay = document.getElementById('payment-amount-display');
            const payNowBtn = document.getElementById('pay-now-btn');
            const paymentTabs = document.querySelectorAll('.payment-tab');
            const paymentForms = document.querySelectorAll('.payment-form');


            // --- Navigation ---
            let currentPage = 'auth-page';
            function showPage(pageId) {
                if (currentPage === pageId) return;
                
                const currentPageEl = document.getElementById(currentPage);
                if(currentPageEl) currentPageEl.classList.remove('active');
                
                const nextPageEl = document.getElementById(pageId);
                if(nextPageEl) nextPageEl.classList.add('active');

                currentPage = pageId;
            }

            // --- UI Updates ---
            function updateUI() {
                if (state.currentUser) {
                    const user = state.users[state.currentUser];
                    const formattedBalance = user.balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    mainBalanceEl.textContent = formattedBalance;
                    walletBalanceEl.textContent = formattedBalance;
                    userEmailDisplay.textContent = state.currentUser;
                    walletAddressEl.textContent = user.address;
                    updateTransactionList();
                } else {
                    showPage('auth-page');
                }
            }
            
            function updateTransactionList() {
                if(!state.currentUser) return;
                const user = state.users[state.currentUser];
                transactionList.innerHTML = '';

                if (user.transactions.length === 0) {
                     transactionList.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 py-4">No transactions yet.</li>';
                     return;
                }

                user.transactions.slice().reverse().forEach(tx => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl';
                    
                    const isSend = tx.type === 'send';
                    const iconColor = isSend ? 'text-red-500' : 'text-green-500';
                    const icon = `<div class="p-2 bg-white dark:bg-gray-800 rounded-full shadow-sm">
                                    <i data-lucide="${isSend ? 'arrow-up-right' : 'arrow-down-left'}" class="h-6 w-6 ${iconColor}"></i>
                                </div>`;

                    const details = isSend ?
                        `<p class="text-sm text-gray-500 dark:text-gray-400">To: ${tx.to.substring(0,10)}...</p>` :
                        `<p class="text-sm text-gray-500 dark:text-gray-400">From: ${tx.from}</p>`;
                    
                    li.innerHTML = `
                        <div class="flex items-center space-x-4">
                           ${icon}
                            <div>
                                <p class="font-semibold">${isSend ? 'Sent Tokens' : 'Received Tokens'}</p>
                                ${details}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${iconColor}">
                                ${isSend ? '-' : '+'} ${tx.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} TKN
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${tx.date}</p>
                        </div>
                    `;
                    transactionList.appendChild(li);
                });
                lucide.createIcons(); // Re-render icons
            }
            
            function showToast(message, type = 'success') {
                toastMessage.textContent = message;
                toast.className = 'toast show text-white font-semibold'; // Reset classes
                if (type === 'error') {
                    toast.classList.add('bg-red-500');
                } else {
                    toast.classList.add('bg-green-500');
                }
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // --- Event Listeners ---
            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                if (state.users[email] && state.users[email].password === password) {
                    state.currentUser = email;
                    saveState();
                    showPage('main-page');
                    updateUI();
                } else {
                    showToast('Invalid email or password.', 'error');
                }
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;

                if (state.users[email]) {
                    showToast('User with this email already exists.', 'error');
                } else {
                    state.users[email] = {
                        password: password,
                        balance: 0,
                        address: `0x${[...Array(20)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
                        transactions: []
                    };
                    state.currentUser = email;
                    saveState();
                    showToast('Registration successful!');
                    showPage('main-page');
                    updateUI();
                }
            });

            walletButton.addEventListener('click', () => showPage('wallet-page'));
            sendButton.addEventListener('click', () => showPage('send-page'));
            receiveButton.addEventListener('click', () => showPage('receive-page'));
            
            backToMainBtns.forEach(btn => {
                btn.addEventListener('click', () => showPage('main-page'));
            });

            logoutButton.addEventListener('click', () => {
                state.currentUser = null;
                saveState();
                updateUI();
            });
            
            copyAddressBtn.addEventListener('click', () => {
                const address = walletAddressEl.textContent;
                const textArea = document.createElement("textarea");
                textArea.value = address;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Address copied to clipboard!');
                } catch (err) {
                    showToast('Failed to copy address.', 'error');
                }
                document.body.removeChild(textArea);
            });
            
            // --- Transaction Logic ---
            const getCurrentDate = () => new Date().toISOString().split('T')[0];

            cashToTokenForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('cash-amount').value);
                if (isNaN(amount) || amount <= 0) return showToast('Please enter a valid amount.', 'error');
                
                state.pendingPurchaseAmount = amount;
                paymentAmountDisplay.textContent = amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                showPage('payment-gateway-page');
                e.target.reset();
            });

            tokenToCashForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('token-amount').value);
                const user = state.users[state.currentUser];

                if (isNaN(amount) || amount <= 0) return showToast('Please enter a valid amount.', 'error');
                if (amount > user.balance) return showToast('Insufficient token balance.', 'error');
                
                user.balance -= amount;
                user.transactions.push({ type: 'send', amount: amount, to: 'Bank Account', date: getCurrentDate() });
                
                showToast(`${amount.toFixed(2)} TKN converted to cash.`);
                saveState();
                updateUI();
                e.target.reset();
            });

            sendTokenForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                const amount = parseFloat(document.getElementById('send-amount').value);
                const recipient = document.getElementById('recipient-address').value;
                const user = state.users[state.currentUser];

                if(!recipient) return showToast('Recipient address is required.', 'error');
                if (isNaN(amount) || amount <= 0) return showToast('Please enter a valid amount.', 'error');
                if (amount > user.balance) return showToast('Insufficient token balance.', 'error');

                user.balance -= amount;
                user.transactions.push({ type: 'send', amount: amount, to: recipient, date: getCurrentDate() });
                
                showToast(`Successfully sent ${amount.toFixed(2)} TKN.`);
                saveState();
                showPage('main-page'); // Go back to main after sending
                updateUI(); // update UI after state change
                e.target.reset();
            });
            
            // --- Payment Gateway Logic ---
            backToWalletBtn.addEventListener('click', () => {
                state.pendingPurchaseAmount = 0;
                showPage('wallet-page');
            });

            paymentTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    paymentTabs.forEach(t => t.classList.remove('text-indigo-600', 'dark:text-indigo-300', 'border-indigo-600', 'dark:border-indigo-300'));
                    tab.classList.add('text-indigo-600', 'dark:text-indigo-300', 'border-indigo-600', 'dark:border-indigo-300');
                    
                    paymentForms.forEach(form => form.classList.add('hidden'));
                    document.getElementById(`${tab.dataset.payment}-payment-form`).classList.remove('hidden');
                });
            });

            payNowBtn.addEventListener('click', () => {
                const amount = state.pendingPurchaseAmount;
                if (!amount || amount <= 0) return;

                const user = state.users[state.currentUser];
                user.balance += amount; 
                user.transactions.push({ type: 'receive', amount: amount, from: 'Cash Deposit', date: getCurrentDate() });
                
                showToast(`Added ${amount.toFixed(2)} TKN to your wallet.`, 'success');
                
                state.pendingPurchaseAmount = 0;
                saveState();
                showPage('wallet-page');
                updateUI();
            });


            // --- Initial Load ---
            loadState();
            updateUI();
        });
    </script>
</body>
</html>

